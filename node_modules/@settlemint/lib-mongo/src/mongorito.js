const { Database } = require('mongorito')

let db = false
const timeout = ms => new Promise(resolve => setTimeout(resolve, ms))
let counter = 10

async function connect(mongodbUri) {
  try {
    if (!db) {
      db = new Database(mongodbUri, {
        keepAlive: 1000,
        reconnectTries: Number.MAX_VALUE,
        reconnectInterval: 1000,
        connectTimeoutMS: 1000,
      })
      await db.connect()
    }
    return db
  } catch (error) {
    if (
      error.message &&
      error.message.match(/on first connect/) &&
      counter > 0
    ) {
      await timeout(5000)
      counter--
      return connect(mongodbUri)
    } else {
      throw error
    }
  }
}

async function disconnect() {
  await db.disconnect()
}

module.exports = {
  connect,
  disconnect,
}
